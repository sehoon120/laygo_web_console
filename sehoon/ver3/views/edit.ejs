<% /* eslint-disable */ %>

<%- include('./include/_header') %>

  <!-- íŒŒì¼ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ (ì™¼ìª½ ìƒë‹¨) -->

  <!-- ==================================================================================================== -->

  <!-- Main -->
  <main id="site-main" class="container my-4">
    <a href="/main?path=<%= encodeURIComponent(currentPath) %>" class="back-button">
      <i class="fas fa-arrow-left"></i> íŒŒì¼ ëª©ë¡
    </a>
    <div class="row">

      <!-- ì™¼ìª½ ì˜ì—­: ê¸€ ì‘ì„± -->
      <div class="col-md-6">
        <h2>
          <%= file.filename %>
        </h2>
        <form id="editForm" action="/main/<%= file._id %>/edit?_method=PUT&path=<%= encodeURIComponent(currentPath) %>"
          method="POST">
          <div class="mb-3">
            <!-- textareaì— ê¸°ë³¸ file.content ê°’ ì±„ì›Œë„£ê¸° -->
            <textarea name="content" class="form-control" rows="48"
              placeholder="Write your code here"><%= file.content %></textarea>
          </div>
          <!-- âœ… Generate ìŠ¤ìœ„ì¹˜ ì¶”ê°€ -->
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="generateSwitch" name="generate" value="on" form="editForm">
            <label class="form-check-label" for="generateSwitch">Generate (Save í›„ ì‹¤í–‰)</label>
          </div>

          <!-- âœ… Save ë²„íŠ¼ ìˆ˜ì • -->
          <button type="submit" class="btn btn-primary" form="editForm">Save</button>

          <!-- âœ… Layout Draw ë²„íŠ¼ ë¶„ë¦¬ -->
          <button id="layoutDrawBtn" type="button" class="btn btn-secondary mt-2">Layout Draw</button>

          <!-- <button type="submit" class="btn btn-primary">Save & Generate</button> -->
        </form>
        <!-- ì €ì¥ ê²°ê³¼ ë©”ì‹œì§€ ì¶œë ¥ ì˜ì—­ -->
        <div id="message" class="mt-3"></div>
      </div>

      <!-- ì˜¤ë¥¸ìª½ ì˜ì—­: ì´ë¯¸ì§€ í‘œì‹œ ë° ì¶”ê°€ ì…ë ¥ë€ -->
      <div class="col-md-6">
        <h2>Layout</h2>

        <!-- ì˜¤ë¥¸ìª½ ìƒë‹¨ì— ì…ë ¥ë€ ì¶”ê°€ -->
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="yamlFileInput">libname</label>
              <input type="text" id="yamlFileInput" name="yamlFile" class="form-control" placeholder="logic_generated"
                form="editForm">
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label for="cellNameInput">cellname</label>
              <input type="text" id="cellNameInput" name="cellname" class="form-control" placeholder="cellname"
                form="editForm">
            </div>
          </div>
        </div>

        <div class="text-center">
          <!-- ê¸°ì¡´ ì´ë¯¸ì§€ ëŒ€ì‹  ìº”ë²„ìŠ¤ ì¶”ê°€ -->
          <canvas id="canvas" width="770" height="1080" style="border:1px solid #ccc; background:#fff;"></canvas>
        </div>
      </div>

    </div>

    <!-- í„°ë¯¸ë„ ì˜ì—­: ë¡œê·¸ íŒŒì¼ ë‚´ìš©ì„ í‘œì‹œ -->
    <div id="terminal"
      style="background-color: black; color: lime; font-family: monospace; padding: 10px; height: 300px; overflow-y: auto; margin-top: 20px;">
      <!-- ë¡œê·¸ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
    </div>
  </main>
  <!-- /Main -->


  <!-- ==================================================================================================== -->

  <!-- ìº”ë²„ìŠ¤ ê¸°ëŠ¥ ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ -->


  <script>
    document.addEventListener("DOMContentLoaded", function() {

      // ================================================================================

      // ì„œë²„ì—ì„œ ì „ë‹¬ëœ drawObjectDocì„ ì „ì—­ ë³€ìˆ˜ë¡œ ì„¤ì • (ë¹ˆ ê°ì²´ë©´ {})
      var drawObjectDoc = (<%- JSON.stringify(drawObjectDoc || {}) %>);
      // console.log("drawObjectDoc:", drawObjectDoc);
    
      // ìº”ë²„ìŠ¤ ë° ì „ì—­ ë³€ìˆ˜ ì„ ì–¸
      var rectList = [];
      var labelList = [];
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      zoomToFit(canvas);   // â† ë°”ìš´ë”© ë°•ìŠ¤ë¡œ ë§ì¶¤
      drawScene(ctx);      // â† setTransform ì ìš©í•´ì„œ ê·¸ë¦¬ê¸°
    
      // ìº”ë²„ìŠ¤ì˜ ë³€í™˜ ìƒíƒœë¥¼ ì¶”ì í•˜ëŠ” í•¨ìˆ˜
      function trackTransforms(ctx) {
        var svg = document.createElementNS("http://www.w3.org/2000/svg", 'svg');
        var xform = svg.createSVGMatrix();
        ctx.getTransform = function () { return xform; };
    
        var savedTransforms = [];
        var save = ctx.save;
        ctx.save = function () {
          savedTransforms.push(xform.translate(0, 0));
          return save.call(ctx);
        };
        var restore = ctx.restore;
        ctx.restore = function () {
          xform = savedTransforms.pop();
          return restore.call(ctx);
        };
    
        var scale = ctx.scale;
        ctx.scale = function (sx, sy) {
          xform = xform.scaleNonUniform(sx, sy);
          return scale.call(ctx, sx, sy);
        };
        var rotate = ctx.rotate;
        ctx.rotate = function (radians) {
          xform = xform.rotate(radians * 180 / Math.PI);
          return rotate.call(ctx, radians);
        };
        var translate = ctx.translate;
        ctx.translate = function (dx, dy) {
          xform = xform.translate(dx, dy);
          return translate.call(ctx, dx, dy);
        };
        var transform = ctx.transform;
        ctx.transform = function (a, b, c, d, e, f) {
          var m2 = svg.createSVGMatrix();
          m2.a = a; m2.b = b; m2.c = c; m2.d = d; m2.e = e; m2.f = f;
          xform = xform.multiply(m2);
          return transform.call(ctx, a, b, c, d, e, f);
        };
        var setTransform = ctx.setTransform;
        ctx.setTransform = function (a, b, c, d, e, f) {
          xform.a = a;
          xform.b = b;
          xform.c = c;
          xform.d = d;
          xform.e = e;
          xform.f = f;
          return setTransform.call(ctx, a, b, c, d, e, f);
        };
        var pt = svg.createSVGPoint();
        ctx.transformedPoint = function (x, y) {
          pt.x = x; pt.y = y;
          return pt.matrixTransform(xform.inverse());
        }
      }
      trackTransforms(ctx);
      // ctx.translate(-385, 540);
      ctx.translate(-385 * 0.05, 1080 - 540 * 0.05);
      ctx.scale(0.05, 0.05);
      ctx.beginPath();
    
      // ì „ì—­ í•¨ìˆ˜ buildMap ë“±ë¡ (window.buildMap)
      window.buildMap = function(docs, cellname, libname) {
        const parent_obj = docs[libname] && docs[libname][cellname];
        if (!parent_obj) {
          console.error("buildMap: docs[" + libname + "][" + cellname + "] is undefined.");
          return;
        }
        for (let child_obj_key in parent_obj) {
          if (child_obj_key === 'masks') {
            const masks = parent_obj[child_obj_key];
            for (let mask_layer_name in masks) {
              const mask_layer = masks[mask_layer_name];
              mask_layer.forEach(mask => {
                let originX = mask[0][0] * 5;
                let originY = mask[0][1] * 5;
                let width = (mask[1][0] - mask[0][0]) * 5;
                let height = (mask[1][1] - mask[0][1]) * 5;
                rectList.push([originX, -originY, width, -height, "rgba(255, 0, 0, 0.5)", mask_layer_name, true, 'mask']);
              });
            }
          } else if (child_obj_key === 'pins') {
            const pins = parent_obj[child_obj_key];
            for (let pin_name in pins) {
              let pin = pins[pin_name];
              let originX = pin['xy'][0][0] * 5;
              let originY = pin['xy'][0][1] * 5;
              let width = (pin['xy'][1][0] - pin['xy'][0][0]) * 5;
              let height = (pin['xy'][1][1] - pin['xy'][0][1]) * 5;
              rectList.push([originX, -originY, width, -height, "rgba(0,255,0, 0.5)", pin_name, true, 'pin']);
            }
          } else if (child_obj_key === 'subblocks') {
            const subblocks = parent_obj[child_obj_key];
            for (let subblock_name in subblocks) {
              let subblock = subblocks[subblock_name];
              if(subblock['libname'] == 'gpdk045_microtemplates_dense'){        //GPDK045ê°€ ì•„ë‹Œ ê²½ìš°ì— ëŒ€í•´ ë‚˜ì¤‘ì— ìˆ˜ì •. íƒ€ ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œë„ "*microtempates*" í˜•íƒœì˜ ì´ë¦„ì¸ì§€ í™•ì¸ í•„ìš”
                if(subblock['transform']=='MX'){
                  let originX = subblock['xy'][0] * 5;
                  let originY = subblock['xy'][1] * 5 - subblock['size'][1] * 5;
                  let width = subblock['size'][0] * 5;
                  let height = subblock['size'][1] * 5;
                  rectList.push([originX, -originY, width, -height, "rgba(0, 0, 0, 1.0)", subblock_name, true, 'subblock']);
                }else{
                  let originX = subblock['xy'][0] * 5;
                  let originY = subblock['xy'][1] * 5;
                  let width = subblock['size'][0] * 5;
                  let height = subblock['size'][1] * 5;
                  rectList.push([originX, -originY, width, -height, "rgba(0, 0, 0, 1.0)", subblock_name, true, 'subblock']);
                }
              }else{
                if(subblock['transform']=='MX'){
                  let subblock_called = docs['logic_generated'][subblock['cellname']];
                  let originX = subblock['xy'][0] * 5;
                  let originY = subblock['xy'][1] * 5 - subblock_called['bbox'][1][1] * 5;
                  let width = subblock_called['bbox'][1][0] * 5;
                  let height = subblock_called['bbox'][1][1] * 5;
                  rectList.push([originX, -originY, width, -height, "rgba(0, 0, 0, 1.0)", subblock_name, true, 'subblock']);
                }else{
                  let subblock_called = docs['logic_generated'][subblock['cellname']];
                  let originX = subblock['xy'][0] * 5;
                  let originY = subblock['xy'][1] * 5;
                  let width = subblock_called['bbox'][1][0] * 5;
                  let height = subblock_called['bbox'][1][1] * 5;
                  rectList.push([originX, -originY, width, -height, "rgba(0, 0, 0, 1.0)", subblock_name, true, 'subblock']);
                }
                
              }               
            }
          }
        }
      };

      // ====================================================================================================
      // yaml format ë³€ê²½ í›„ ì˜ˆìƒ ë¹Œë“œë§µ

      // ì „ì—­: rectList, labelList ì‚¬ìš© (í•„ìš” ì‹œ ì´ˆê¸°í™”)
      window.buildMap_ver2 = function(cellObj) {
        const SCALE = 5;
        // window.rectList = [];
        // window.labelList = [];
        const rectList  = (window.rectList  = []);
        const labelList = (window.labelList = []);

        const cellname = cellObj.cellname || "(unknown)";
        const libname  = cellObj.libname  || "(unknown)";

        const metalColor = (layer) => {
          if (!layer) return "rgba(0,0,255,0.35)";
          const L = String(layer).toLowerCase();
          if (L.includes('metal1')) return "rgba(0,128,255,0.35)";
          if (L.includes('metal2')) return "rgba(255,128,0,0.35)";
          if (L.includes('metal3')) return "rgba(160,32,240,0.35)";
          return "rgba(0,0,255,0.35)";
        };

        function pushRectFromXY(xy, color, label, kind, meta={}) {
          if (!xy || xy.length !== 2) return;
          const ox = xy[0][0] * SCALE;
          const oy = xy[0][1] * SCALE;
          const w  = (xy[1][0] - xy[0][0]) * SCALE;
          const h  = (xy[1][1] - xy[0][1]) * SCALE;

          rectList.push([ox, -oy, w, -h, color, label, true, kind, meta]);
          // ë¼ë²¨
          labelList.push({
            x: ox + 2, y: -(oy) - 2, text: label,
            font: "11px sans-serif", fill: "#222",
            align: "left", baseline: "top", z: 50
          });
        }

        // 0) bbox (ì…€ ì™¸ê³½)
        if (Array.isArray(cellObj.bbox) && cellObj.bbox.length === 2) {
          const [p0, p1] = cellObj.bbox;
          const ox = p0[0] * SCALE, oy = p0[1] * SCALE;
          const w  = (p1[0] - p0[0]) * SCALE;
          const h  = (p1[1] - p0[1]) * SCALE;
          rectList.push([ox, -oy, w, -h, "rgba(128,128,128,0.12)", "bbox", true, "bbox", {kind:"bbox"}]);
        }

        // 1) metals
        if (Array.isArray(cellObj.metals)) {
          cellObj.metals.forEach((m, i) => {
            const color = metalColor(m.layer);
            const label = `${m.layer || "Metal"} #${i}`;
            pushRectFromXY(m.xy, color, label, "metal", { layer: m.layer || "" });
          });
        }

        // 2) pins
        if (Array.isArray(cellObj.pins)) {
          cellObj.pins.forEach((p) => {
            const name = p.name || p.netname || "pin";
            pushRectFromXY(p.xy, "rgba(0,200,0,0.55)", String(name), "pin", {
              layer: p.layer || "", netname: p.netname || ""
            });
          });
        }

        // 3) subblocks
        if (Array.isArray(cellObj.subblocks)) {
          cellObj.subblocks.forEach((sb) => {
            const instName = sb.name || "(inst)";
            const instLib  = sb.libname || "";
            const instCell = sb.cellname || "";
            const xy       = sb.xy || [0,0];
            const tr       = sb.transform || "R0";

            // subblock í¬ê¸° ì¶”ì •: microtemplatesëŠ” ë‚´ë¶€ì ìœ¼ë¡œ sizeê°€ ìˆìœ¼ë‹ˆ,
            // YAMLì— ë°”ë¡œ sizeê°€ ì—†ìœ¼ë©´ ë¼ì´ë¸ŒëŸ¬ë¦¬ bboxë¥¼ ë°±ì—”ë“œì—ì„œ ë¶™ì—¬ì˜¤ê²Œ í•˜ëŠ” ê²Œ ê°€ì¥ ì •í™•.
            // ì¼ë‹¨ ì—¬ê¸°ì„œëŠ” gpdk045_microtemplates_denseëŠ” ëŒ€ê°œ bboxê°€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì •ì˜ì— ìˆìŒ â†’ ë°±ì—”ë“œê°€ ë³‘í•©í•´ ë‚´ë ¤ì£¼ê¸¸ ê¶Œì¥.
            const bbox = sb.bbox || cellObj.__libBBoxes?.[`${instLib}:${instCell}`]; // (ì˜µì…˜) ë°±ì—”ë“œê°€ í•©ì³ì„œ ë‚´ë ¤ì¤€ ê²½ìš°
            if (!bbox || bbox.length !== 2) {
              console.warn("subblock bbox missing; skip:", sb);
              return;
            }

            const w = (bbox[1][0] - bbox[0][0]) * SCALE;
            const h = (bbox[1][1] - bbox[0][1]) * SCALE;

            let ox = xy[0] * SCALE;
            let oy = xy[1] * SCALE;
            if (tr === "MX") oy -= h;

            // ì‚¬ê°í˜•
            rectList.push([ox, -oy, w, -h, "rgba(0,0,0,1.0)", instName, true, "subblock", {
              kind:"subblock", instName, instLib, instCell, transform: tr
            }]);

            // ë¼ë²¨(ë‘ ì¤„)
            labelList.push({ x: ox+2, y: -(oy)-2,  text: `Inst: ${instName}`, font: "12px sans-serif", fill:"#000", align:"left", baseline:"top", z: 70 });
            labelList.push({ x: ox+2, y: -(oy)-16, text: `Lib: ${instLib}, Cell: ${instCell}`, font: "11px sans-serif", fill:"#444", align:"left", baseline:"top", z: 70 });
          });
        }

        // 4) ìƒë‹¨ ì˜¤ë²„ë ˆì´: cell/lib
        labelList.push({ x: 10, y: 10, text: `cellname: ${cellname}`, font: "bold 14px sans-serif", fill: "#111", align: "left", baseline: "top", z: 1000 });
        labelList.push({ x: 10, y: 28, text: `libname: ${libname}`,   font: "12px sans-serif",       fill: "#333", align: "left", baseline: "top", z: 1000 });
      };


      const view = { scale: 1, offsetX: 0, offsetY: 0 };

      function canonicalRect(r) {
        const [x, y, w, h] = r;
        return { left: x, top: y + h, width: w, height: -h };
      }

      function computeBounds(rects) {
        if (!rects || rects.length === 0) return null;
        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
        for (const r of rects) {
          const { left, top, width, height } = canonicalRect(r);
          const right = left + width, bottom = top + height;
          if (left < minX) minX = left;
          if (top  < minY) minY = top;
          if (right > maxX) maxX = right;
          if (bottom > maxY) maxY = bottom;
        }
        return { minX, minY, maxX, maxY, width: maxX - minX, height: maxY - minY };
      }

      function zoomToFit(canvas, margin = 20) {
        const b = computeBounds(window.rectList);
        if (!b) return;
        const sx = (canvas.width  - margin * 2) / Math.max(b.width, 1);
        const sy = (canvas.height - margin * 2) / Math.max(b.height, 1);
        const s  = Math.max(0.1, Math.min(sx, sy));
        view.scale   = s;
        view.offsetX = margin - b.minX * s;
        view.offsetY = margin - b.minY * s;
      }

      function drawScene(ctx) {
        const { width, height } = ctx.canvas;
        ctx.clearRect(0, 0, width, height);

        ctx.save();
        ctx.setTransform(view.scale, 0, 0, view.scale, view.offsetX, view.offsetY);

        for (const [x, y, w, h, color] of window.rectList) {
          ctx.fillStyle = color || 'rgba(0,0,0,0.3)';
          ctx.fillRect(x, y, w, h);
        }

        if (window.labelList) {
          for (const l of window.labelList) {
            ctx.font         = l.font || "12px sans-serif";
            ctx.fillStyle    = l.fill || "#000";
            ctx.textAlign    = l.align || "left";
            ctx.textBaseline = l.baseline || "alphabetic";
            ctx.fillText(l.text, l.x, l.y);
          }
        }
        ctx.restore();
      }

      function redraw() {
        const canvas = document.getElementById("layoutCanvas");
        const ctx = canvas.getContext("2d");
        zoomToFit(canvas);   // â­ í•œë²ˆë§Œ ë§ì¶°ë„ í™”ë©´ì— ëœ¸
        drawScene(ctx);
      }




      // ê·¸ë¦¬ê¸° ì˜ˆì‹œ
      function drawScene(ctx) {
        // rect ê·¸ë¦¬ê¸° (ìˆœì„œëŒ€ë¡œ)
        rectList.forEach(([x, y, w, h, color]) => {
          ctx.fillStyle = color;
          ctx.fillRect(x, y, w, h);
        });

        // ë¼ë²¨ì€ z ì •ë ¬ í›„ ê·¸ë¦¬ê¸°
        const sorted = [...labelList].sort((a,b) => (a.z||0) - (b.z||0));
        sorted.forEach(l => {
          ctx.font = l.font || "12px sans-serif";
          ctx.fillStyle = l.fill || "#000";
          ctx.textAlign = l.align || "left";
          ctx.textBaseline = l.baseline || "alphabetic";
          ctx.fillText(l.text, l.x, l.y);
        });
      }


      // ====================================================================================================

      function drawOriginAxes() {
        ctx.save();
        ctx.strokeStyle = '#0077cc';
        ctx.lineWidth = 20;

        const LONG = 100000;

        // Xì¶•: y=0, ì¢Œìš° ì „ì²´ ê·¸ë¦¬ê¸°
        ctx.beginPath();
        ctx.moveTo(385 - LONG, 540);  // ì‹œì‘ì : ì™¼ìª½ìœ¼ë¡œ
        ctx.lineTo(385 + LONG, 540);   // ëì : ì˜¤ë¥¸ìª½ìœ¼ë¡œ
        ctx.stroke();

        // Yì¶•: x=0, ìœ„ì•„ë˜ ì „ì²´ ê·¸ë¦¬ê¸°
        ctx.beginPath();
        ctx.moveTo(385, 540 - LONG);  // ì‹œì‘ì : ìœ„ìª½ìœ¼ë¡œ
        ctx.lineTo(385, 540 + LONG);   // ëì : ì•„ë˜ìª½ìœ¼ë¡œ
        ctx.stroke();

        ctx.restore();
      }
    
      // ìº”ë²„ìŠ¤ ì¬ë Œë”ë§ í•¨ìˆ˜
      function redraw() {
        ctx.save();
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.restore();

          // === origin ì¶• í‘œì‹œ ===
        ctx.save();
        ctx.beginPath();
        ctx.lineWidth = 1;
        ctx.strokeStyle = "#444";  // ì—°í•œ íšŒìƒ‰
        const pt0 = ctx.transformedPoint(0, 0);
        const ptX1 = ctx.transformedPoint(canvas.width, 0);
        const ptY1 = ctx.transformedPoint(0, canvas.height);

        drawOriginAxes(); 
        
        rectList.forEach(rect => {
          if (rect[6]) {
            if (rect[7] === 'subblock') {
              ctx.lineWidth = 10;
              ctx.strokeStyle = rect[4];
              ctx.fillStyle = rect[4];
              ctx.strokeRect(rect[0], rect[1], rect[2], rect[3]);
              ctx.font = "400px Verdana";
              ctx.fillText(rect[5], rect[0] + rect[2] / 2 - 200, rect[1] + rect[3] / 2 - 200);
            } else if (rect[7] === 'pin') {
              ctx.fillStyle = rect[4];
              ctx.fillRect(rect[0], rect[1], rect[2], rect[3]);
              ctx.fillStyle = 'rgba(255, 0, 0, 1.0)';
              ctx.font = "400px Verdana";
              ctx.fillText(rect[5], rect[0] + rect[2] / 2 - 200, rect[1] + rect[3] / 2 - 200);
            } else { // mask
              ctx.fillStyle = rect[4];
              ctx.fillRect(rect[0], rect[1], rect[2], rect[3]);
            }
          }
        });
      }
      redraw();
    
      // ìº”ë²„ìŠ¤ ë“œë˜ê·¸ ë° ì¤Œ ì¸í„°ë™ì…˜ ì²˜ë¦¬
      let lastX = canvas.width / 2, lastY = canvas.height / 2;
      let dragStart, dragged;
      canvas.addEventListener('mousedown', function (evt) {
        document.body.style.userSelect = 'none';
        lastX = evt.offsetX;
        lastY = evt.offsetY;
        dragStart = ctx.transformedPoint(lastX, lastY);
        dragged = false;
      });
      canvas.addEventListener('mousemove', function (evt) {
        lastX = evt.offsetX;
        lastY = evt.offsetY;
        dragged = true;
        if (dragStart) {
          let pt = ctx.transformedPoint(lastX, lastY);
          ctx.translate(pt.x - dragStart.x, pt.y - dragStart.y);
          redraw();
        }
      });
      canvas.addEventListener('mouseup', function (evt) {
        dragStart = null;
        if (!dragged) zoom(evt.shiftKey ? -1 : 1);
      });
      const scaleFactor = 1.1;
      function zoom(clicks) {
        let pt = ctx.transformedPoint(lastX, lastY);
        ctx.translate(pt.x, pt.y);
        let factor = Math.pow(scaleFactor, clicks);
        ctx.scale(factor, factor);
        ctx.translate(-pt.x, -pt.y);
        redraw();
      }
      function handleScroll(evt) {
        let delta = evt.wheelDelta ? evt.wheelDelta / 40 : evt.detail ? -evt.detail : 0;
        if (delta) zoom(delta);
        evt.preventDefault();
        return false;
      }
      canvas.addEventListener('DOMMouseScroll', handleScroll, false);
      canvas.addEventListener('mousewheel', handleScroll, false);
    
      // í¼ ì œì¶œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (AJAX)
      document.getElementById("editForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        console.log("í¼ ì œì¶œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì‹¤í–‰ë¨");
        // í¼ ì œì¶œ ì‹œ ìµœì‹  ì…ë ¥ê°’ ì½ê¸°
        const cellname = document.getElementById("cellNameInput").value || 'cellname';
        const libname = document.getElementById("yamlFileInput").value || 'logic_generated';
        // console.log("Submitted cellname:", cellname);
        // console.log("Submitted libname:", libname);
    
        const form = e.target;
        const formData = new FormData(form);
        const data = new URLSearchParams();
        for (const pair of formData) {
          data.append(pair[0], pair[1]);
        }
        try {
          const response = await fetch(form.action, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: data,
            credentials: 'include'
          });
          const result = await response.json();
          console.log("AJAX ì‘ë‹µ:", result);
          let messageDiv = document.getElementById("message");
          // if (response.ok && result.success) {
          //   messageDiv.innerText = "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.";
          //   if (result.drawObjectDoc) {
          //     rectList = [];
          //     buildMap(result.drawObjectDoc, cellname, libname);
          //     redraw();
          //   }
          // } 
          if (response.ok && result.success) {    // switchì— ë”°ë¼ ë‹¤ë¥¸ ì‘ë‹µ
            const generateSwitch = document.getElementById("generateSwitch");
            if (generateSwitch && generateSwitch.checked) {
              messageDiv.innerText = "Generate ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";
            } else {
              messageDiv.innerText = "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.";
            }

            // if (result.drawObjectDoc) {
            //   rectList = [];
            //   buildMap(result.drawObjectDoc, cellname, libname);
            //   redraw();
            // }
            // Saveì—ì„  layoutì„ ì ˆëŒ€ ê·¸ë¦¬ì§€ ì•Šë„ë¡
            // if (result.drawObjectDoc && result.libname && result.cellname) {
            //   rectList = [];
            //   buildMap(result.drawObjectDoc, result.cellname, result.libname);
            //   redraw();
            // }
          } 
          else {
            messageDiv.innerText = "ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
          }
          messageDiv.style.opacity = 1;
          setTimeout(() => {
            messageDiv.style.transition = "opacity 0.5s ease-out";
            messageDiv.style.opacity = 0;
          }, 2000);
        } catch (error) {
          let messageDiv = document.getElementById("message");
          messageDiv.innerText = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
          messageDiv.style.opacity = 1;
          setTimeout(() => {
            messageDiv.style.transition = "opacity 0.5s ease-out";
            messageDiv.style.opacity = 0;
          }, 2000);
          console.error(error);
        }
      });
    
      // default layout function
      // document.getElementById("layoutDrawBtn").addEventListener("click", async function () {
      //   console.log("ğŸ“ Layout Draw ë²„íŠ¼ í´ë¦­ë¨");

      //   // í•„ìš”í•œ ì…ë ¥ê°’ ì¶”ì¶œ
      //   const cellname = document.getElementById("cellNameInput").value || 'cellname';
      //   const libname = document.getElementById("yamlFileInput").value || 'logic_generated';

      //   const form = document.getElementById("editForm");
      //   const formData = new FormData(form);

      //   const data = new URLSearchParams();
      //   for (const pair of formData) {
      //     data.append(pair[0], pair[1]);
      //   }

      //   try {
      //     const response = await fetch(`${form.action}/draw`, {   // âœ… draw ì „ìš© ë¼ìš°í„° í˜¸ì¶œ
      //       method: 'POST',
      //       headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      //       body: data,
      //       credentials: 'include'
      //     });

      //     const result = await response.json();
      //     console.log("ğŸ¯ Layout Draw ì‘ë‹µ:", result);

      //     const messageDiv = document.getElementById("message");
      //     if (response.ok && result.drawObjectDoc) {
      //       const { drawObjectDoc, cellname, libname } = result;
      //       const messageDiv = document.getElementById("message");

      //       if (
      //         drawObjectDoc.hasOwnProperty(libname) &&
      //         drawObjectDoc[libname].hasOwnProperty(cellname)
      //       ) {
      //         setTimeout(() => {
      //           messageDiv.innerText = 'âœ… Layout Draw ì„±ê³µ';
      //         }, 2000); // 2ì´ˆ í›„ì— ë©”ì‹œì§€ ì œê±°

      //         // messageDiv.innerText = "âœ… Layout Draw ì„±ê³µ";
      //         rectList = [];
      //         buildMap(drawObjectDoc, cellname, libname);
      //         redraw();
      //       } else {
      //         setTimeout(() => {
      //           messageDiv.innerText = `âš ï¸ Layout Draw ì‹¤íŒ¨: ${libname} / ${cellname} ì—†ìŒ`;
      //         }, 2000);
      //         // messageDiv.innerText = `âš ï¸ Layout Draw ì‹¤íŒ¨: ${libname} / ${cellname} ì—†ìŒ`;
      //         console.warn(`drawObjectDoc[${libname}][${cellname}] is undefined`);
      //       }
      //     }
      //   } catch (error) {
      //     console.error("âŒ Layout Draw ì˜¤ë¥˜:", error);
      //     document.getElementById("message").innerText = "ì„œë²„ ì˜¤ë¥˜ë¡œ Layoutì„ ê·¸ë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
      //   }
      // });


      // í„°ë¯¸ë„ ì˜ì—­ í´ë§ (2ì´ˆ ê°„ê²©)
      
      // ê¸°ì¡´ buildMap ì „ìš©
      // document.getElementById("layoutDrawBtn").addEventListener("click", async function () {
      //   const form = document.getElementById("editForm");
      //   const urlObj = new URL(form.action, window.location.origin);
      //   const basePath = urlObj.pathname; // "/main/:id/edit"
      //   const pathParam = urlObj.searchParams.get('path') || '/';

      //   // âœ… ì§„ì§œ draw ê²½ë¡œë¡œ ë³´ëƒ„ (ì¿¼ë¦¬ ì•ì— /drawë¥¼ ë¶™ì¸ë‹¤)
      //   const drawUrl = `${basePath}/draw?path=${encodeURIComponent(pathParam)}`;

      //   const formData = new FormData(form);
      //   // ì‚¬ìš©ìê°€ ì…ë ¥í•œ lib/cell ë¹„ë©´ ë¹ˆ ë¬¸ìì—´ë¡œ ë³´ë‚´ì„œ ì„œë²„ê°€ ì¶”ë¡ í•˜ë„ë¡
      //   const cellFromInput = (document.getElementById("cellNameInput").value || '').trim();
      //   const libFromInput  = (document.getElementById("yamlFileInput").value || '').trim();
      //   formData.set('cellname', cellFromInput);
      //   formData.set('libname', libFromInput);

      //   const data = new URLSearchParams();
      //   for (const pair of formData) data.append(pair[0], pair[1]);

      //   try {
      //     const response = await fetch(drawUrl, {
      //       method: 'POST', // drawëŠ” POSTë¡œ
      //       headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      //       body: data,
      //       credentials: 'include'
      //     });

      //     const result = await response.json();
      //     console.log("ğŸ¯ Layout Draw ì‘ë‹µ:", result);

      //     const msg = document.getElementById("message");
      //     if (response.ok && result.drawObjectDoc) {
      //       const lib  = result.resolvedLibname || libFromInput || 'logic_generated';
      //       const cell = result.resolvedCellname || cellFromInput || 'cellname';

      //       if (result.drawObjectDoc?.[lib]?.[cell]) {
      //         msg.innerText = 'âœ… Layout Draw ì„±ê³µ';
      //         rectList = [];
      //         buildMap(result.drawObjectDoc, cell, lib);
      //         redraw();
      //       } else {
      //         msg.innerText = `âš ï¸ Layout Draw ì‹¤íŒ¨: ${lib} / ${cell} ì—†ìŒ`;
      //         console.warn(`drawObjectDoc[${lib}][${cell}] is undefined`);
      //       }
      //     } else {
      //       msg.innerText = result?.message || 'âš ï¸ Layout Draw ì‹¤íŒ¨';
      //     }
      //   } catch (err) {
      //     console.error("âŒ Layout Draw ì˜¤ë¥˜:", err);
      //     document.getElementById("message").innerText = "ì„œë²„ ì˜¤ë¥˜ë¡œ Layoutì„ ê·¸ë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
      //   }
      // });


      // ì‹ ê·œ buildMap_ver2 ì „ìš©
      document.getElementById("layoutDrawBtn").addEventListener("click", async function () {
        const form = document.getElementById("editForm");
        const urlObj = new URL(form.action, window.location.origin);
        const basePath = urlObj.pathname; // "/main/:id/edit"
        const pathParam = urlObj.searchParams.get('path') || '/';

        // âœ… draw ì „ìš© ê²½ë¡œ
        const drawUrl = `${basePath}/draw?path=${encodeURIComponent(pathParam)}`;

        const formData = new FormData(form);
        // ì‚¬ìš©ìê°€ ì…ë ¥í•œ lib/cell(ë¹„ì›Œë„ ë°±ì—”ë“œê°€ ì¶”ì¶œ ì‹œë„)
        const cellFromInput = (document.getElementById("cellNameInput").value || '').trim();
        const libFromInput  = (document.getElementById("yamlFileInput").value || '').trim();
        formData.set('cellname', cellFromInput);
        formData.set('libname',  libFromInput);

        const body = new URLSearchParams();
        for (const pair of formData) body.append(pair[0], pair[1]);

        const msgEl = document.getElementById("message");

        try {
          const response = await fetch(drawUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body,
            credentials: 'include'
          });

          const result = await response.json();
          console.log("ğŸ¯ Layout Draw ì‘ë‹µ:", result);

          // âœ… ì‹ ê·œ í¬ë§·: drawObjectDocëŠ” "ë‹¨ì¼ ì…€ ì˜¤ë¸Œì íŠ¸"
          if (response.ok && result.success && result.drawObjectDoc) {
            const cellObj = result.drawObjectDoc; // { bbox, metals, pins, subblocks, ... }
            const libName  = cellObj.libname  || result.resolvedLibname  || '(unknown lib)';
            const cellName = cellObj.cellname || result.resolvedCellname || '(unknown cell)';

            // í™”ë©´ ë©”ì‹œì§€
            msgEl.innerText = `âœ… Layout Draw ì„±ê³µ: ${libName} / ${cellName}`;

            // ìº”ë²„ìŠ¤ ë°ì´í„° ì´ˆê¸°í™” í›„ ê·¸ë¦¬ê¸°
            window.rectList  = [];
            window.labelList = [];
            buildMap_ver2(cellObj);   // â¬…ï¸ ë³€ê²½ í¬ì¸íŠ¸: (cellObj) ë‹¨ì¼ ì¸ì
            console.log('rect count:', window.rectList.length); // ë””ë²„ê·¸
            redraw();            // ë„¤ê°€ ì“°ëŠ” ê¸°ì¡´ ë Œë” í•¨ìˆ˜ í˜¸ì¶œ
          } else {
            msgEl.innerText = result?.message || 'âš ï¸ Layout Draw ì‹¤íŒ¨';
          }
        } catch (err) {
          console.error("âŒ Layout Draw ì˜¤ë¥˜:", err);
          msgEl.innerText = "ì„œë²„ ì˜¤ë¥˜ë¡œ Layoutì„ ê·¸ë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        }
      });

      
      setInterval(async () => {
        try {
          const fileId = "<%= file._id %>";
          const response = await fetch(`/main/${fileId}/edit/logs`, { credentials: 'include' });
          if (!response.ok) {
            console.error("ë¡œê·¸ íŒŒì¼ ìš”ì²­ ì‹¤íŒ¨:", response.status);
          }
          const text = await response.text();
          try {
            const result = JSON.parse(text);
            document.getElementById("terminal").innerText = result.log;
          } catch (parseError) {
            console.error("JSON íŒŒì‹± ì—ëŸ¬:", parseError);
          }
        } catch (error) {
          console.error("ë¡œê·¸ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì—ëŸ¬ ë°œìƒ:", error);
        }
      }, 2000);
    });
    </script>
    


  <!-- ==================================================================================================== -->

  <%- include('./include/_footer') %>